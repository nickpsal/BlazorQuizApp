@page "/quiz"
@rendermode InteractiveServer

<PageTitle>Weather</PageTitle>
<h3>Quiz1</h3>

@if (quizData == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card-body">
        @foreach (var question in quizData)
        {
            <div> 
                @question.question <br />
                @foreach(var answer in question.Answers)
                {
                    <label><input type="radio" checked="@IsOptionSelected(question.question, answer)" @onchange='() => SetSelectedChoice(question.question, answer)' />@answer</label>
                    <br />
                }
                @if (Messages.Count != 0)
                {
                    <div>@Messages[question.question]</div>
                }
            </div>
        }
        @if (!isFinished)
        {
            <button @onclick="HandleSubmit">Submit</button>
            <button @onclick="HandleClear">Clear</button>
        }else {
            <button @onclick="HandleClear">Retry</button>
        }
    </div>
}

@code {
    private int CorrectAnswersCounter = 0;
    private bool isFinished = false;
    public List<QuizData> quizData { get; set; } = new();
    private Dictionary<string, string> selectedChoices = new Dictionary<string, string>();
    private Dictionary<string, string> Messages = new Dictionary<string, string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadQuestions();
        ShuffleQuestions();
        ShuffleAnswers();
        InitializeSelectedChoice();
    }

    private void InitializeSelectedChoice()
    {
        foreach (var question in quizData)
        {
            selectedChoices[question.question] = "";
        }
    }

    private bool IsOptionSelected(string question, string option)
    {
        return selectedChoices[question] == option;
    }

    private void SetSelectedChoice(string question, string option)
    {
        selectedChoices[question] = option;
    }

    private void initializeMessages()
    {
        foreach (var question in quizData)
        {
            Messages[question.question] = "";
        }
    }

    protected void HandleSubmit()
    {
        initializeMessages();
        checkAnswers();
        isFinished = true;
    }

    protected void HandleClear()
    {
        isFinished = false;
        ShuffleQuestions();
        ShuffleAnswers();
        initializeMessages();
        foreach(var question in quizData)
        {
            SetSelectedChoice(question.question, "");
        }
    }

    private void checkAnswers()
    {
        foreach (var question in quizData)
        {
            if (question.correct == selectedChoices[question.question])
            {
                Messages[question.question] = "Your Answer is Correct.";
                CorrectAnswersCounter++;
            }else
            {
                Messages[question.question] = "Your Answer was Incorrect.";
            }
        }
    }

    private async Task LoadQuestions()
    {
        string path = "Data/quiz.dat";
        // Use StreamReaderAsync to read the contents asynchronously.
        using (StreamReader reader = new StreamReader(path))
        {
            // Read the contents asynchronously.
            string json = await reader.ReadToEndAsync();
            // Create a JsonSerializerOptions object to specify the options for deserializing the JSON data.
            JsonSerializerOptions options = new JsonSerializerOptions();
            options.PropertyNameCaseInsensitive = true;
            // Deserialize the JSON data into a strongly typed object using the JsonSerializer.Deserialize<T>() method.
            quizData = JsonSerializer.Deserialize<List<QuizData>>(json, options)!;
        }
    }

    private void ShuffleQuestions()
    {
        Random random = new Random();
        quizData = quizData.OrderBy(x => random.Next()).ToList();
    }

    private void ShuffleAnswers()
    {
        Random random = new Random();
        foreach(var question in quizData)
        {
            question.Answers = question.Answers.OrderBy(x => random.Next()).ToList();
        }
    }
}
